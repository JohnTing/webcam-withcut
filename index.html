<!DOCTYPE html>
<html>

<head>

    <title>Camera Cropping</title>
    <link rel="manifest" href="manifest.json" />

</head>

<style>
    canvas {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }
</style>

<body>
    <video id="video" width="0" height="0" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <input type="range" id="sx" min="-1000" max="1000" value="0" onchange="updateValue()">
    <input type="range" id="sy" min="-1000" max="1000" value="0" onchange="updateValue()">
    <input type="range" id="sw" min="1" max="2000" value="640" onchange="updateValue()">
    <input type="range" id="sh" min="1" max="2000" value="480" onchange="updateValue()">
    <!--


    <br/>
    <input type="range" id="dx"  min="0" max="1000" value="0" onchange="updateValue()">
    <input type="range" id="dy"  min="0" max="1000" value="0" onchange="updateValue()">
    <input type="range" id="dw"  min="0" max="1000" value="250" onchange="updateValue()"> 
    <input type="range" id="dh"  min="0" max="1000" value="250" onchange="updateValue()">
        -->
    <script>

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('./sw.js').then(function (registration) {
                    // Registration was successful
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function (err) {
                    // registration failed :(
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }



        // 訪問攝像頭
        /** @type {HTMLVideoElement} */
        const video = document.getElementById('video');

        /** @type {HTMLCanvasElement} */
        const canvas = document.getElementById('canvas');
        console.log(canvas.width, canvas.height)
        let sx = 0;
        let sy = 0;
        let sw = 0;
        let sh = 0;

        let dx = 0;
        let dy = 0;
        let dw = 0;
        let dh = 0;

        function updateValue() {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            sx = Number(document.getElementById('sx').value);
            sy = Number(document.getElementById('sy').value);
            console.log(sy)


            sw = 2001 - document.getElementById('sw').value;
            sh = 2001 - document.getElementById('sh').value;
            /*
            dx = document.getElementById('dx').value;
            dy = document.getElementById('dy').value;
            dw = document.getElementById('dw').value;
            dh = document.getElementById('dh').value;*/

        }
        updateValue();

        navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: { exact: "environment" },
            },
        })
            .then(function (stream) {

                video.srcObject = stream;
                video.play();
            })
            .catch(function (err) {
                console.log("An error occurred: " + err);
            });


        function captureFrame() {
            // 將整個攝像頭畫面繪製到canvas上
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);


        }

        setInterval(captureFrame, 1000 / 30); // 每秒30幀更新畫面

        // 監聽頁面的 "fullscreenchange" 事件
        document.addEventListener("fullscreenchange", function () {
            if (document.fullscreenElement) {
                // 進入全螢幕模式
                //canvas.width = screen.width;
                //canvas.height = screen.height;
            } else {
                // 退出全螢幕模式
                //canvas.width = 640;
                //canvas.height = 480;
            }
        });

        // 點擊 Canvas 進入全螢幕模式
        canvas.addEventListener("click", function () {
            /*
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                canvas.requestFullscreen();
            }*/
        });



    </script>
</body>

</html>